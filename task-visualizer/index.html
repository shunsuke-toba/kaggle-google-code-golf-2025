<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Google Code Golf 2025 - Task Visualizer</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>

<body class="bg-gray-100">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;

    // カラーパレット（ARC-AGI標準）
    const COLORS = {
      0: '#000000', // Black
      1: '#0074D9', // Blue
      2: '#FF4136', // Red
      3: '#2ECC40', // Green
      4: '#FFDC00', // Yellow
      5: '#AAAAAA', // Gray
      6: '#F012BE', // Magenta
      7: '#FF851B', // Orange
      8: '#7FDBFF', // Cyan
      9: '#870C25', // Brown
    };

    // グリッドコンポーネント
    const Grid = ({ grid, title }) => {
      if (!grid || !Array.isArray(grid)) return null;

      const cellSize = Math.min(20, 500 / Math.max(grid.length, grid[0]?.length || 1));

      return (
        <div className="bg-white p-4 rounded-lg shadow-md">
          <h3 className="text-sm font-semibold mb-2 text-gray-700">{title}</h3>
          <div className="inline-block border border-gray-300">
            {grid.map((row, i) => (
              <div key={i} className="flex">
                {row.map((cell, j) => (
                  <div
                    key={`${i}-${j}`}
                    style={{
                      width: `${cellSize}px`,
                      height: `${cellSize}px`,
                      backgroundColor: COLORS[cell] || '#FFFFFF',
                      border: '1px solid #e5e7eb'
                    }}
                  />
                ))}
              </div>
            ))}
          </div>
        </div>
      );
    };

    // Example Pairコンポーネント
    const ExamplePair = ({ example, index, type }) => {
      return (
        <div className="mb-6 p-4 bg-gray-50 rounded-lg">
          <h3 className="text-lg font-semibold mb-3 text-gray-800">
            {type} Example {index + 1}
          </h3>
          <div className="flex gap-4 items-center">
            <Grid grid={example.input} title="Input" />
            <svg className="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 7l5 5m0 0l-5 5m5-5H6" />
            </svg>
            <Grid grid={example.output} title="Output" />
          </div>
        </div>
      );
    };

    // 折りたたみセクションコンポーネント
    const CollapsibleSection = ({ title, count, children, defaultOpen = false }) => {
      const [isOpen, setIsOpen] = useState(defaultOpen);

      return (
        <div className="mb-6 bg-white rounded-lg shadow-md overflow-hidden">
          <button
            onClick={() => setIsOpen(!isOpen)}
            className="w-full px-4 py-3 bg-gray-50 hover:bg-gray-100 transition-colors flex items-center justify-between text-left"
          >
            <h2 className="text-xl font-bold text-gray-800">
              {title} ({count} examples)
            </h2>
            <svg
              className={`w-5 h-5 text-gray-600 transition-transform ${isOpen ? 'transform rotate-180' : ''}`}
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
            </svg>
          </button>
          {isOpen && (
            <div className="p-4">
              {children}
            </div>
          )}
        </div>
      );
    };

    // メインアプリケーション
    const App = () => {
      const [taskList, setTaskList] = useState([]);
      const [selectedTask, setSelectedTask] = useState('');
      const [selectedFile, setSelectedFile] = useState('');
      const [taskData, setTaskData] = useState(null);
      const [loading, setLoading] = useState(false);
      const [error, setError] = useState('');
      const [useFileInput, setUseFileInput] = useState(false);

      // タスクファイル一覧を生成
      useEffect(() => {
        const tasks = [];
        for (let i = 1; i <= 400; i++) {
          const taskNum = String(i).padStart(3, '0');
          tasks.push(`task${taskNum}.json`);
        }
        setTaskList(tasks);

        // サーバー経由でアクセス可能かチェック
        fetch('../in/task001.json')
          .then(() => setUseFileInput(false))
          .catch(() => setUseFileInput(true));
      }, []);

      // タスクファイルを読み込む（サーバー経由）
      const loadTask = async (taskFile) => {
        if (!taskFile) return;

        setLoading(true);
        setError('');

        try {
          const response = await fetch(`../in/${taskFile}`);
          if (!response.ok) {
            throw new Error(`Failed to load ${taskFile}`);
          }
          const data = await response.json();
          setTaskData(data);
        } catch (err) {
          setError(`Error loading task: ${err.message}`);
          setTaskData(null);
        } finally {
          setLoading(false);
        }
      };

      // タスク選択時の処理（ドロップダウン）
      const handleTaskSelect = (e) => {
        const taskFile = e.target.value;
        setSelectedTask(taskFile);
        loadTask(taskFile);
      };

      // ファイル選択時の処理（ファイル入力）
      const handleFileSelect = (e) => {
        const file = e.target.files[0];
        if (!file) return;

        setSelectedFile(file.name);
        setLoading(true);
        setError('');

        const reader = new FileReader();
        reader.onload = (event) => {
          try {
            const data = JSON.parse(event.target.result);
            setTaskData(data);
            setLoading(false);
          } catch (err) {
            setError(`Error parsing JSON: ${err.message}`);
            setTaskData(null);
            setLoading(false);
          }
        };
        reader.onerror = () => {
          setError('Error reading file');
          setTaskData(null);
          setLoading(false);
        };
        reader.readAsText(file);
      };

      return (
        <div className="container mx-auto p-6 max-w-7xl">
          <h1 className="text-3xl font-bold mb-6 text-gray-800">
            Google Code Golf 2025 - Task Visualizer
          </h1>

          {/* タスクセレクター */}
          <div className="mb-6 bg-white p-4 rounded-lg shadow-md">
            {useFileInput ? (
              <>
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  Select Task JSON File:
                </label>
                <input
                  type="file"
                  accept=".json"
                  onChange={handleFileSelect}
                  className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                />
                {selectedFile && (
                  <p className="mt-2 text-sm text-gray-600">Selected: {selectedFile}</p>
                )}
                <p className="mt-2 text-xs text-gray-500">
                  inフォルダ内のtaskXXX.jsonファイルを選択してください
                </p>
                <p className="mt-2 text-xs text-orange-600">
                  サーバーモードで使用するには: npm run dev
                </p>
              </>
            ) : (
              <>
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  Select Task:
                </label>
                <select
                  value={selectedTask}
                  onChange={handleTaskSelect}
                  className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                >
                  <option value="">-- Select a task --</option>
                  {taskList.map(task => (
                    <option key={task} value={task}>{task}</option>
                  ))}
                </select>
              </>
            )}
          </div>

          {/* ローディング表示 */}
          {loading && (
            <div className="text-center py-8">
              <div className="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-gray-900"></div>
              <p className="mt-2 text-gray-600">Loading task data...</p>
            </div>
          )}

          {/* エラー表示 */}
          {error && (
            <div className="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4">
              {error}
            </div>
          )}

          {/* タスクデータ表示 */}
          {taskData && !loading && (
            <div>
              {/* カラーレジェンド */}
              <div className="mb-6 bg-white p-4 rounded-lg shadow-md">
                <h2 className="text-lg font-semibold mb-3">Color Legend</h2>
                <div className="flex flex-wrap gap-2">
                  {Object.entries(COLORS).map(([value, color]) => (
                    <div key={value} className="flex items-center gap-2">
                      <div
                        className="w-6 h-6 border border-gray-300"
                        style={{ backgroundColor: color }}
                      />
                      <span className="text-sm text-gray-700">{value}</span>
                    </div>
                  ))}
                </div>
              </div>

              {/* Training Examples */}
              {taskData.train && taskData.train.length > 0 && (
                <CollapsibleSection
                  title="Training Examples"
                  count={taskData.train.length}
                  defaultOpen={true}
                >
                  {taskData.train.map((example, index) => (
                    <ExamplePair key={index} example={example} index={index} type="Training" />
                  ))}
                </CollapsibleSection>
              )}

              {/* Test Examples */}
              {taskData.test && taskData.test.length > 0 && (
                <CollapsibleSection
                  title="Test Examples"
                  count={taskData.test.length}
                  defaultOpen={false}
                >
                  {taskData.test.map((example, index) => (
                    <ExamplePair key={index} example={example} index={index} type="Test" />
                  ))}
                </CollapsibleSection>
              )}

              {/* ARC-GEN Examples */}
              {taskData['arc-gen'] && taskData['arc-gen'].length > 0 && (
                <CollapsibleSection
                  title="ARC-GEN Examples"
                  count={taskData['arc-gen'].length}
                  defaultOpen={false}
                >
                  {taskData['arc-gen'].map((example, index) => (
                    <ExamplePair key={index} example={example} index={index} type="ARC-GEN" />
                  ))}
                </CollapsibleSection>
              )}
            </div>
          )}
        </div>
      );
    };

    // アプリケーションをレンダリング
    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>

</html>
