# Task 066: 緑から赤への制約付きパス探索

# 問題の考察ポイントと解き方

## 考察ポイント

1. **色の役割と意味**

   - 緑色(3): 開始位置（複数セルの塊）
   - 赤色(2): ゴール位置（複数セルの塊）
   - 水色(8): 障害物（方向転換可能地点）
   - 背景(0): 通行可能なセル

2. **移動の制約**

   - 直進制約: 一度方向を決めたら障害物にぶつかるまで直進
   - 方向転換: 水色ブロック(8)にぶつかった時のみ可能
   - 最大転換回数: 2 回まで
   - 訪問制約: 同じセルを 2 度通ることはできない

3. **初期方向の決定ロジック**

   - 緑ブロックの形状から初期方向を推定
   - 横長の緑ブロック → 左右方向を優先
   - 縦長の緑ブロック → 上下方向を優先
   - 赤ブロックへの距離を考慮して優先順位を決定

4. **探索戦略**
   - DFS（深さ優先探索）による経路探索
   - バックトラッキングで複数の可能性を試行
   - グリッドのコピーを使用して探索の副作用を管理

## 解くための手続き

1. **初期化処理**

   - グリッドサイズ(h, w)を取得
   - 緑色(3)のセル位置をすべて収集してソート
   - 赤色(2)のセル位置をすべて収集してソート
   - 位置が見つからない場合は元のグリッドを返す

2. **初期方向の決定**

   - 緑ブロックが 2 セル以上の場合:
     - 同じ行にある場合 → 赤ブロックの重心位置と比較して左右の優先順位を決定
     - 同じ列にある場合 → 上下方向を試行
   - 緑ブロックが 1 セルの場合 → 4 方向すべてを試行

3. **パス探索アルゴリズム**

   - 各初期方向と各緑セルの組み合わせで探索開始
   - グリッドをコピーして作業用グリッドを作成
   - 再帰的な探索関数で以下を実行:
     - 現在の方向に直進（障害物または境界まで）
     - 赤色に到達したら成功を返す
     - 水色にぶつかり、転換回数が残っている場合:
       - 垂直方向への転換を試みる
       - 赤ブロックへの距離で優先順位を決定
       - 各方向で再帰的に探索

4. **パスの記録**

   - 探索中、通過した背景セル(0)を緑色(3)に変更
   - 成功したパスが見つかったら、そのグリッドを返す
   - すべての組み合わせで失敗したら元のグリッドを返す

5. **最適化のポイント**
   - 早期終了: 最初の有効なパスが見つかったら即座に返す
   - 距離計算: マンハッタン距離で赤ブロックへの近さを評価
   - グリッドコピー: 探索の分岐点でのみコピーを作成
